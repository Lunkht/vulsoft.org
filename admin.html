<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Vulsoft</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Vulsoft">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icon-16x16.png">

    <link rel="stylesheet" href="css/main.css">
    <style>
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-title-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-logo {
            width: 40px;
            height: 40px;
            filter: var(--logo-filter);
            opacity: 0.9;
        }
        
        .admin-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-logout-btn {
            background: #ff4d4f;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .admin-logout-btn:hover {
            background: #ff7875;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-description {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }
        
        .users-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .users-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            width: 300px;
            max-width: 100%;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .pagination {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .pagination button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--accent-color);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .active {
            background: var(--accent-color);
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-table th,
        .users-table td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .users-table th {
            background: var(--input-bg);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
        }
        
        .users-table td {
            color: var(--text-secondary);
        }
        
        .user-role {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .user-role.admin {
            background: #6366f1;
            color: #fff;
        }
        
        .user-role.user {
            background: #333;
            color: #ccc;
        }
        
        .user-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .user-status.active {
            background: #3ecf8e;
        }
        
        .user-status.inactive {
            background: #ff4d4f;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }
        
        .error {
            background: #ff4d4f;
            color: #fff;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .refresh-btn {
            background: #6366f1;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: #5855eb;
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .users-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                width: 100%;
            }
            
            .users-table {
                font-size: 0.85rem;
            }
            
            .users-table th,
            .users-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
    <script src="js/vulsoft-auth.js"></script>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title-container">
                <img src="images/icone.svg" alt="Vulsoft" class="admin-logo">
                <h1 class="admin-title">Administration Vulsoft</h1>
            </div>
            <div class="admin-user-info">
                <span data-user="name">Chargement...</span>
                <button class="admin-logout-btn" id="logout-btn">Déconnexion</button>
            </div>
        </div>
        
        <!-- Statistiques -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Utilisateurs totaux</div>
                <div class="stat-value" id="total-users">-</div>
                <div class="stat-description">Comptes créés</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Utilisateurs actifs</div>
                <div class="stat-value" id="active-users">-</div>
                <div class="stat-description">Comptes activés</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Nouveaux aujourd'hui</div>
                <div class="stat-value" id="new-users-today">-</div>
                <div class="stat-description">Inscriptions du jour</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Connexions aujourd'hui</div>
                <div class="stat-value" id="login-attempts-today">-</div>
                <div class="stat-description">Tentatives de connexion</div>
            </div>
        </div>
        
        <!-- Gestion des utilisateurs -->
        <div class="users-section">
            <h2 class="section-title">Gestion des utilisateurs</h2>
            
            <div class="users-controls">
                <input type="text" class="search-input" id="search-input" placeholder="Rechercher un utilisateur...">
                <div class="pagination" id="pagination">
                    <button id="refresh-btn" class="refresh-btn">Actualiser</button>
                </div>
            </div>
            
            <div id="users-content">
                <div class="loading">Chargement des utilisateurs...</div>
            </div>
        </div>
    </div>
    
    <script>
        // Vérification de l'authentification et des droits admin
        const auth = new VulsoftAuth({
            apiUrl: 'http://localhost:3000/api',
            onAuthStateChanged: (user) => {
                if (!user) {
                    window.location.href = 'auth.html';
                } else if (user.role !== 'admin') {
                    alert('Accès refusé. Droits administrateur requis.');
                    window.location.href = 'index.html';
                }
            }
        });
        
        const authUI = new VulsoftAuthUI(auth);
        
        // Variables globales
        let currentPage = 1;
        let totalPages = 1;
        let searchTerm = '';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifier l'authentification
            if (!auth.isAuthenticated() || !auth.isAdmin()) {
                window.location.href = 'auth.html';
                return;
            }
            
            // Mettre à jour l'interface utilisateur
            authUI.updateAuthState(auth.getCurrentUser());
            
            // Charger les données
            await loadStats();
            await loadUsers();
            
            // Événements
            setupEventListeners();
        });
        
        // Configuration des événements
        function setupEventListeners() {
            // Déconnexion
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await auth.logout();
            });
            
            // Recherche
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTerm = e.target.value;
                    currentPage = 1;
                    loadUsers();
                }, 500);
            });
            
            // Actualisation
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadStats();
                loadUsers();
            });
        }
        
        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await auth.request('/admin/stats');
                
                if (response.stats) {
                    document.getElementById('total-users').textContent = response.stats.totalUsers || 0;
                    document.getElementById('active-users').textContent = response.stats.activeUsers || 0;
                    document.getElementById('new-users-today').textContent = response.stats.newUsersToday || 0;
                    document.getElementById('login-attempts-today').textContent = response.stats.loginAttemptsToday || 0;
                }
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
                showError('Erreur lors du chargement des statistiques');
            }
        }
        
        // Charger la liste des utilisateurs
        async function loadUsers() {
            const usersContent = document.getElementById('users-content');
            usersContent.innerHTML = '<div class="loading">Chargement des utilisateurs...</div>';
            
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 10
                });
                
                if (searchTerm) {
                    params.append('search', searchTerm);
                }
                
                const response = await auth.request(`/admin/users?${params}`);
                
                if (response.users && response.users.length > 0) {
                    totalPages = response.pagination.pages;
                    renderUsersTable(response.users);
                    renderPagination(response.pagination);
                } else {
                    usersContent.innerHTML = '<div class="empty-state">Aucun utilisateur trouvé</div>';
                }
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
                usersContent.innerHTML = '<div class="error">Erreur lors du chargement des utilisateurs</div>';
            }
        }
        
        // Afficher le tableau des utilisateurs
        function renderUsersTable(users) {
            const usersContent = document.getElementById('users-content');
            
            const table = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>Email</th>
                            <th>Rôle</th>
                            <th>Statut</th>
                            <th>Inscription</th>
                            <th>Dernière connexion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>
                                    <span class="user-status ${user.isActive ? 'active' : 'inactive'}"></span>
                                    ${user.firstName} ${user.lastName}
                                </td>
                                <td>${user.email}</td>
                                <td><span class="user-role ${user.role}">${user.role}</span></td>
                                <td>${user.isActive ? 'Actif' : 'Inactif'}</td>
                                <td>${formatDate(user.createdAt)}</td>
                                <td>${user.lastLogin ? formatDate(user.lastLogin) : 'Jamais'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            usersContent.innerHTML = table;
        }
        
        // Afficher la pagination
        function renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            
            const buttons = [];
            
            // Bouton précédent
            buttons.push(`
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
                    Précédent
                </button>
            `);
            
            // Numéros de page
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                buttons.push(`
                    <button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                        ${i}
                    </button>
                `);
            }
            
            // Bouton suivant
            buttons.push(`
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
                    Suivant
                </button>
            `);
            
            // Bouton actualiser
            buttons.push('<button id="refresh-btn" class="refresh-btn">Actualiser</button>');
            
            paginationEl.innerHTML = buttons.join('');
            
            // Réattacher l'événement d'actualisation
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadStats();
                loadUsers();
            });
        }
        
        // Changer de page
        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadUsers();
            }
        }
        
        // Formater une date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Afficher une erreur
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.admin-container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    </script>
    <script src="js/pwa.js"></script>
</body>
</html>